<div class="h-full flex flex-col bg-white dark:bg-slate-800">
  <!-- Header -->
  <div class="flex-shrink-0 h-16 flex items-center justify-between px-4 border-b border-gray-200 dark:border-slate-700">
    <div class="flex items-center space-x-2 min-w-0">
      <span class="flex-shrink-0 p-1 rounded-full" [class]="'bg-' + ({web: 'blue', email: 'green', chat: 'purple'}[ticket().channel]) + '-100 dark:bg-' + ({web: 'blue', email: 'green', chat: 'purple'}[ticket().channel]) + '-900/50'">
          <app-icon [name]="{web: 'help-circle', email: 'inbox', chat: 'message-circle'}[ticket().channel]" [class]="'w-5 h-5 text-' + ({web: 'blue', email: 'green', chat: 'purple'}[ticket().channel]) + '-600 dark:text-' + ({web: 'blue', email: 'green', chat: 'purple'}[ticket().channel]) + '-400'"></app-icon>
      </span>
      <div class="min-w-0">
        <h2 class="text-lg font-bold truncate text-gray-900 dark:text-slate-100" [title]="ticket().subject">#{{ ticket().id }} - {{ ticket().subject }}</h2>
      </div>
      @if (otherViewingAgents().length > 0) {
        <div class="flex items-center text-xs text-gray-500 dark:text-slate-400" [title]="'Also viewing: ' + otherViewingAgents().join(', ')">
          <app-icon name="eye" class="w-4 h-4 mr-1"></app-icon>
          <span>+{{ otherViewingAgents().length }}</span>
        </div>
      }
    </div>
    <div class="flex items-center space-x-2">
       @if(ticket().status === 'resolved') {
        <button (click)="generateKb()" [disabled]="isGeneratingKb()" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md disabled:opacity-50 disabled:cursor-wait" title="Generate Knowledge Base Article">
         <app-icon [name]="isGeneratingKb() ? 'loader' : 'file-question'" class="w-5 h-5"></app-icon>
       </button>
       }
       <button (click)="showMergeModal.set(true)" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md" title="Merge Ticket">
         <app-icon name="merge" class="w-5 h-5"></app-icon>
       </button>
        <button (click)="showLogTimeModal.set(true)" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md" title="Log Time">
         <app-icon name="clock" class="w-5 h-5"></app-icon>
       </button>
        <button (click)="showLinkModal.set(true)" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md" title="Link Ticket">
         <app-icon name="link" class="w-5 h-5"></app-icon>
       </button>
       <button (click)="close.emit()" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md" title="Close Ticket View">
         <app-icon name="x" class="w-5 h-5"></app-icon>
       </button>
    </div>
  </div>

  <div class="flex-1 flex overflow-hidden">
    <!-- Main Conversation -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- AI Tools -->
      <div class="p-3 bg-gray-50 dark:bg-slate-900/50 border-b border-gray-200 dark:border-slate-700 flex items-center space-x-2 flex-wrap gap-y-2">
        <app-icon name="sparkles" class="w-5 h-5 text-purple-500"></app-icon>
        <span class="text-sm font-semibold">AI Tools:</span>
        <button (click)="summarize()" [disabled]="isSummarizing()" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline disabled:opacity-50 disabled:cursor-wait">
            @if(isSummarizing()) { <span>Summarizing...</span> } @else { <span>Summarize</span> }
        </button>
        <button (click)="suggestReplies()" [disabled]="isSuggestingReplies()" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline disabled:opacity-50 disabled:cursor-wait">
            @if(isSuggestingReplies()) { <span>Suggesting...</span> } @else { <span>Suggest Replies</span> }
        </button>
         <button (click)="getAnswerFromKb()" [disabled]="isAnsweringFromKb()" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline disabled:opacity-50 disabled:cursor-wait">
            @if(isAnsweringFromKb()) { <span>Answering...</span> } @else { <span>Answer from KB</span> }
        </button>
      </div>

      <!-- AI Output -->
      @if (ticketSummary()) {
        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/50 border-b border-indigo-200 dark:border-indigo-800">
            <h4 class="font-semibold text-sm text-indigo-800 dark:text-indigo-300 mb-2">AI Summary</h4>
            <div class="prose prose-sm text-indigo-700 dark:text-indigo-200" [innerHTML]="ticketSummary()"></div>
        </div>
      }

       @if (kbAnswer(); as kb) {
        <div class="p-4 bg-indigo-50 dark:bg-indigo-900/50 border-b border-indigo-200 dark:border-indigo-800">
          <h4 class="font-semibold text-sm text-indigo-800 dark:text-indigo-300 mb-2">AI Answer from Knowledge Base</h4>
          <p class="text-sm text-indigo-700 dark:text-indigo-200 mb-3">{{ kb.answer }}</p>
          @if(kb.sources.length > 0) {
            <div class="text-xs">
              <span class="text-indigo-600 dark:text-indigo-400 font-semibold">Sources:</span>
              @for(source of kb.sources; track source.id) {
                <a href="#" class="ml-2 text-indigo-600 dark:text-indigo-300 hover:underline">{{ source.title }}</a>
              }
            </div>
          }
        </div>
       }

       @if (suggestedReplies().length > 0) {
        <div class="p-4 bg-gray-50 dark:bg-slate-900/50 border-b border-gray-200 dark:border-slate-700">
            <h4 class="font-semibold text-sm mb-2">Suggested Replies</h4>
            <div class="flex flex-wrap gap-2">
                @for(reply of suggestedReplies(); track reply) {
                    <button (click)="useSuggestedReply(reply)" class="text-sm text-left bg-white dark:bg-slate-700 p-2 rounded-md border hover:bg-gray-100 dark:hover:bg-slate-600">{{reply}}</button>
                }
            </div>
        </div>
      }

      <!-- Conversation History -->
      <div class="flex-1 overflow-y-auto p-4 space-y-4">
        @for (item of conversationItems(); track item.timestamp) {
          @if (item.itemType === 'message') {
            @let message = item;
            <div class="flex items-start space-x-3 group">
              <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-white" [class]="message.type === 'agent' ? 'bg-indigo-500' : 'bg-gray-500'">
                {{ getInitials(message.from) }}
              </div>
              <div class="flex-1 p-3 rounded-lg border" [class]="message.type === 'agent' ? 'bg-indigo-50 dark:bg-indigo-900/50 border-indigo-200 dark:border-indigo-800' : 'bg-white dark:bg-slate-700 border-gray-200 dark:border-slate-600'">
                <div class="flex justify-between items-center mb-1">
                  <span class="font-semibold text-sm text-gray-900 dark:text-slate-100">{{ message.from }}</span>
                  <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-500 dark:text-slate-400">{{ formatDate(message.timestamp) }}</span>
                    <button (click)="openSplitTicketModal(message)" class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-indigo-600" title="Split to New Ticket">
                        <app-icon name="split" class="w-4 h-4"></app-icon>
                    </button>
                  </div>
                </div>
                <p class="text-sm text-gray-800 dark:text-slate-300 whitespace-pre-wrap">{{ message.content }}</p>
              </div>
            </div>
          } @else {
            @let note = item;
            <div class="flex items-start space-x-3">
              <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center bg-yellow-100 dark:bg-yellow-900/50">
                <app-icon name="lock" class="w-4 h-4 text-yellow-600 dark:text-yellow-400"></app-icon>
              </div>
              <div class="flex-1 p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/50 border border-yellow-200 dark:border-yellow-800">
                <div class="flex justify-between items-center mb-1">
                  <span class="font-semibold text-sm text-yellow-800 dark:text-yellow-200">Internal Note by {{ note.from }}</span>
                  <span class="text-xs text-yellow-600 dark:text-yellow-400">{{ formatDate(note.timestamp) }}</span>
                </div>
                <p class="text-sm text-yellow-800 dark:text-yellow-300 whitespace-pre-wrap">{{ note.content }}</p>
              </div>
            </div>
          }
        }
      </div>

      <!-- Reply Box -->
      <div class="flex-shrink-0 border-t border-gray-200 dark:border-slate-700 p-4 bg-gray-50 dark:bg-slate-900/50">
        <div class="flex space-x-2 border-b border-gray-200 dark:border-slate-700 mb-2">
          <button (click)="replyMode.set('customer')" [class]="'px-3 py-1.5 text-sm font-medium rounded-t-md ' + (replyMode() === 'customer' ? 'bg-white dark:bg-slate-800 text-indigo-600' : 'text-gray-500 hover:bg-white/50 dark:hover:bg-slate-800/50')">Reply to Customer</button>
          <button (click)="replyMode.set('internal')" [class]="'px-3 py-1.5 text-sm font-medium rounded-t-md ' + (replyMode() === 'internal' ? 'bg-yellow-50 dark:bg-yellow-900/50 text-yellow-700' : 'text-gray-500 hover:bg-white/50 dark:hover:bg-slate-800/50')">Add Internal Note</button>
        </div>
        <div class="bg-white dark:bg-slate-800 rounded-b-md border border-gray-200 dark:border-slate-700">
          <textarea #replyTextarea [(ngModel)]="replyText" class="w-full p-2 border-0 focus:ring-0 resize-none bg-transparent" [placeholder]="replyMode() === 'customer' ? 'Type your reply...' : 'Type your internal note...' " rows="4"></textarea>
          <div class="p-2 border-t border-gray-200 dark:border-slate-700 flex justify-between items-center flex-wrap">
            <div class="flex items-center space-x-1 flex-wrap">
               <div class="relative">
                <button (click)="showCannedResponses.set(!showCannedResponses())" class="flex items-center space-x-1 p-2 text-sm text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                    <app-icon name="messagesquare" class="w-4 h-4"></app-icon>
                    <span>Canned Responses</span>
                    <app-icon name="chevrondown" class="w-4 h-4"></app-icon>
                </button>
                @if (showCannedResponses()) {
                    <div class="absolute bottom-full left-0 mb-2 w-72 bg-white dark:bg-slate-800 rounded-lg shadow-lg border dark:border-slate-700 z-10 max-h-60 overflow-y-auto">
                        @for (response of filteredCannedResponses(); track response.id) {
                            <button (click)="handleCannedResponse(response.content)" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700">{{ response.name }}</button>
                        }
                    </div>
                }
               </div>
               <div class="relative">
                <button (click)="showMacros.set(!showMacros())" class="flex items-center space-x-1 p-2 text-sm text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                    <app-icon name="play-circle" class="w-4 h-4"></app-icon>
                    <span>Apply Macro</span>
                    <app-icon name="chevrondown" class="w-4 h-4"></app-icon>
                </button>
                 @if (showMacros()) {
                    <div class="absolute bottom-full left-0 mb-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow-lg border dark:border-slate-700 z-10">
                        @for (macro of macros(); track macro.id) {
                            <button (click)="handleMacro(macro)" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700">{{ macro.name }}</button>
                        }
                    </div>
                }
               </div>
               <div class="flex items-center space-x-1 pl-2 border-l border-gray-200 dark:border-slate-700">
                  <span class="text-xs text-gray-500 dark:text-slate-400">Tone:</span>
                  <button (click)="changeReplyTone('Friendly')" [disabled]="isChangingTone() || !replyText()" class="px-2 py-1 text-xs rounded-md bg-white dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 disabled:opacity-50">Friendly</button>
                  <button (click)="changeReplyTone('Formal')" [disabled]="isChangingTone() || !replyText()" class="px-2 py-1 text-xs rounded-md bg-white dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 disabled:opacity-50">Formal</button>
                  @if(isChangingTone()) { <app-icon name="loader" class="w-4 h-4 text-indigo-500"></app-icon> }
               </div>
            </div>
            <button (click)="handleReply()" [disabled]="!replyText().trim()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 disabled:bg-gray-400">Send</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Customer 360 Sidebar -->
    <aside class="w-80 flex-shrink-0 border-l border-gray-200 dark:border-slate-700 flex flex-col">
       <div class="border-b border-gray-200 dark:border-slate-700">
        <nav class="-mb-px flex">
            <button (click)="activeTab360.set('contact')" [class]="'w-1/3 py-3 text-sm font-medium text-center border-b-2 ' + (activeTab360() === 'contact' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700')">Contact</button>
            <button (click)="activeTab360.set('organization')" [class]="'w-1/3 py-3 text-sm font-medium text-center border-b-2 ' + (activeTab360() === 'organization' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700')">Organization</button>
            <button (click)="activeTab360.set('timeline')" [class]="'w-1/3 py-3 text-sm font-medium text-center border-b-2 ' + (activeTab360() === 'timeline' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700')">Timeline</button>
        </nav>
       </div>
       <div class="flex-1 overflow-y-auto p-4 space-y-6">
        @switch (activeTab360()) {
          @case ('contact') {
            @if(contact(); as c) {
              <div class="text-center">
                <div class="w-20 h-20 rounded-full bg-gray-200 dark:bg-slate-700 mx-auto flex items-center justify-center text-3xl font-bold text-gray-600 dark:text-slate-300 mb-2">
                  {{ getInitials(c.name) }}
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-slate-100">{{ c.name }}</h3>
                <p class="text-sm text-gray-500 dark:text-slate-400">{{ c.title }}</p>
              </div>
              <div class="space-y-3 text-sm">
                 <div>
                    <span class="font-semibold text-gray-600 dark:text-slate-400">Email</span>
                    <p class="text-gray-800 dark:text-slate-200">{{ c.email }}</p>
                </div>
                <div>
                    <span class="font-semibold text-gray-600 dark:text-slate-400">Organization</span>
                    <p class="text-indigo-600 dark:text-indigo-400">{{ organization()?.name }}</p>
                </div>
              </div>
            }
          }
          @case ('organization') {
            @if(organization(); as org) {
               <div>
                  <h3 class="text-lg font-bold text-gray-900 dark:text-slate-100 mb-4">{{ org.name }}</h3>
                   <div class="space-y-3 text-sm">
                     <div>
                        <span class="font-semibold text-gray-600 dark:text-slate-400">Industry</span>
                        <p class="text-gray-800 dark:text-slate-200">{{ org.industry }}</p>
                    </div>
                     <div>
                        <span class="font-semibold text-gray-600 dark:text-slate-400">SLA Tier</span>
                        <p class="text-gray-800 dark:text-slate-200">{{ org.slaTier }}</p>
                    </div>
                     <div>
                        <span class="font-semibold text-gray-600 dark:text-slate-400">VIP Status</span>
                        @if(org.isVip) {
                           <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300">VIP</span>
                        } @else {
                           <p class="text-gray-800 dark:text-slate-200">Standard</p>
                        }
                    </div>
                  </div>
               </div>
            }
          }
          @case ('timeline') {
            <div>
              <h3 class="text-lg font-bold text-gray-900 dark:text-slate-100 mb-4">Customer Timeline</h3>
              <ul class="space-y-4">
                @for(event of timelineEvents(); track $index) {
                  <li class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center" [ngClass]="{
                        'bg-blue-100 dark:bg-blue-900/50': event.itemType === 'activity',
                        'bg-green-100 dark:bg-green-900/50': event.itemType === 'message' && event.type === 'customer',
                        'bg-indigo-100 dark:bg-indigo-900/50': event.itemType === 'message' && event.type === 'agent',
                        'bg-yellow-100 dark:bg-yellow-900/50': event.itemType === 'note'
                    }">
                      <app-icon [name]="{activity: 'mail', message: 'messagesquare', note: 'lock'}[event.itemType]" class="w-4 h-4" [ngClass]="{
                        'text-blue-600 dark:text-blue-400': event.itemType === 'activity',
                        'text-green-600 dark:text-green-400': event.itemType === 'message' && event.type === 'customer',
                        'text-indigo-600 dark:text-indigo-400': event.itemType === 'message' && event.type === 'agent',
                        'text-yellow-600 dark:text-yellow-400': event.itemType === 'note'
                      }"></app-icon>
                    </div>
                     <div class="flex-1 text-sm">
                        @if(event.itemType === 'activity') {
                            <p class="text-gray-800 dark:text-slate-200">
                                <a (click)="selectTicket.emit(event.ticketId)" class="font-semibold hover:underline cursor-pointer">Ticket #{{event.ticketId}}</a> created: "{{event.subject}}"
                            </p>
                        } @else if(event.itemType === 'message') {
                            <p class="text-gray-800 dark:text-slate-300 line-clamp-2" [title]="event.content">{{ event.content }}</p>
                             <p class="text-xs text-gray-500 dark:text-slate-400">
                                Reply from {{event.from}} on <a (click)="selectTicket.emit(event.ticketId)" class="hover:underline cursor-pointer">#{{event.ticketId}}</a>
                            </p>
                        } @else {
                             <p class="text-yellow-800 dark:text-yellow-300 line-clamp-2" [title]="event.content">{{ event.content }}</p>
                             <p class="text-xs text-yellow-600 dark:text-yellow-400">
                                Note by {{event.from}} on <a (click)="selectTicket.emit(event.ticketId)" class="hover:underline cursor-pointer">#{{event.ticketId}}</a>
                            </p>
                        }
                        <p class="text-xs text-gray-400 dark:text-slate-500">{{ formatDate(event.timestamp) }}</p>
                    </div>
                  </li>
                }
              </ul>
            </div>
          }
        }
       </div>
    </aside>
  </div>
</div>

@if (showMergeModal()) {
    <app-merge-ticket-modal [currentTicket]="ticket()" [allTickets]="allTickets()" [contacts]="contacts()" (close)="showMergeModal.set(false)" (merge)="handleMerge($event)"></app-merge-ticket-modal>
}
@if (showLogTimeModal()) {
    <app-log-time-modal (close)="showLogTimeModal.set(false)" (logTime)="handleLogTime($event)"></app-log-time-modal>
}
@if (showSplitTicketModal()) {
    <app-split-ticket-modal [messageToSplit]="messageToSplit()!" (close)="showSplitTicketModal.set(false)" (split)="handleSplitTicket($event)"></app-split-ticket-modal>
}
@if (showLinkModal()) {
    <app-link-ticket-modal [currentTicket]="ticket()" [allTickets]="allTickets()" [contacts]="contacts()" (close)="showLinkModal.set(false)" (link)="handleLink($event)"></app-link-ticket-modal>
}