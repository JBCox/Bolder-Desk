<div class="fixed bottom-5 right-5 z-50">
  @if (!isOpen()) {
    <button (click)="toggleChat()" class="bg-indigo-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-indigo-700 transition">
      <app-icon name="message-circle" class="w-8 h-8"></app-icon>
    </button>
  } @else {
    <div class="w-96 h-[32rem] bg-white dark:bg-slate-800 rounded-lg shadow-2xl flex flex-col">
      <div class="bg-indigo-600 text-white p-4 rounded-t-lg flex justify-between items-center">
        <div>
          <h3 class="font-bold">Chat with us</h3>
          @if (session()?.agentId) {
            <p class="text-sm opacity-80">You're talking to an agent</p>
          } @else {
             <p class="text-sm opacity-80">We'll be with you shortly</p>
          }
        </div>
        <button (click)="toggleChat()" class="text-white opacity-80 hover:opacity-100">
            <app-icon name="x-circle" class="w-6 h-6"></app-icon>
        </button>
      </div>

      <div #chatBody class="flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-slate-900 space-y-4">
        @if (!session()) {
            <div class="text-center text-gray-500 dark:text-slate-400 text-sm p-4">
                Ask us anything! Let us know if you have a question about our product or pricing.
            </div>
        } @else {
            @for(message of session()?.transcript; track $index) {
                <div [class]="'flex items-end gap-2 ' + (message.sender === 'customer' ? 'justify-end' : '')">
                    @if (message.sender === 'agent') {
                        <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white text-sm flex-shrink-0">{{ message.name.charAt(0) }}</div>
                    }
                    <div [class]="'max-w-xs p-3 rounded-lg ' + (message.sender === 'customer' ? 'bg-indigo-500 text-white' : 'bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600')">
                        <p class="text-sm dark:text-slate-200">{{ message.content }}</p>
                        <p [class]="'text-xs mt-1 ' + (message.sender === 'customer' ? 'text-indigo-200' : 'text-gray-400 dark:text-slate-500')">{{ formatTimestamp(message.timestamp) }}</p>
                    </div>
                </div>
            }
        }
      </div>

      <div class="p-4 bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
          <div class="flex items-center space-x-2">
            <input 
              type="text" 
              placeholder="Type your message..." 
              class="flex-1 px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-700 dark:text-slate-200"
              [(ngModel)]="messageText"
              (keydown.enter)="handleSendMessage()"
            >
            <button (click)="handleSendMessage()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700">Send</button>
          </div>
        </div>
    </div>
  }
</div>
