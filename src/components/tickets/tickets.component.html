<div class="flex h-full">
  <!-- Filter Panel -->
  @if (showFilterPanel()) {
    <div class="w-96 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col text-slate-800 dark:text-slate-200">
      <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
        <h3 class="text-lg font-semibold">Filters</h3>
        <button (click)="toggleFilterPanel()" class="p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
          <app-icon name="x" class="w-5 h-5"></app-icon>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-4">
        @for (group of panelFilters(); track group.id; let gIndex = $index) {
          <div class="p-2 bg-slate-100 dark:bg-slate-700/50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <select (change)="updateGroupMatchType(gIndex, $event)" class="text-sm font-semibold bg-transparent border-0 focus:ring-0 p-1 rounded-md hover:bg-slate-200 dark:hover:bg-slate-600">
                <option value="all" [selected]="group.matchType === 'all'">Match ALL</option>
                <option value="any" [selected]="group.matchType === 'any'">Match ANY</option>
              </select>
              @if (panelFilters().length > 1) {
                <button (click)="removeConditionGroup(gIndex)" class="text-xs text-red-500 hover:underline">Remove Group</button>
              }
            </div>
            <div class="space-y-1">
              @for (condition of group.conditions; track condition.id; let cIndex = $index) {
                @let fieldDef = getFieldDef(condition.field);
                <div class="grid grid-cols-[1fr,1fr,minmax(120px,1.5fr),auto] gap-3 items-center">
                  <select (change)="updateConditionField(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0">
                    <option value="" disabled [selected]="!condition.field">Select field...</option>
                    @for (field of availableFilterFields(); track field.id) { <option [value]="field.id" [selected]="condition.field === field.id">{{ field.name }}</option> }
                  </select>
                  <select (change)="updateConditionOperator(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0">
                    @for(operator of getOperatorsForFieldType(fieldDef?.type); track operator.id) {
                      <option [value]="operator.id" [selected]="condition.operator === operator.id">{{ operator.name }}</option>
                    }
                  </select>
                  @if (condition.field && !['is_set', 'is_not_set'].includes(condition.operator)) {
                    @switch (fieldDef?.type) {
                      @case ('dropdown') {
                        @if (condition.operator === 'is_one_of') {
                          <input type="text" [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0" placeholder="value1,value2">
                        } @else {
                          <select [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0">
                            @for (opt of fieldDef.options; track opt) { <option [value]="opt">{{opt}}</option> }
                          </select>
                        }
                      }
                      @case ('agent_dropdown') {
                        @if (condition.operator === 'is_one_of') {
                          <input type="text" [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0" placeholder="Agent1,Agent2">
                        } @else {
                          <select [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0">
                            <option value="unassigned">Unassigned</option>
                            @for (agent of app.agents(); track agent.id) { <option [value]="agent.name">{{agent.name}}</option> }
                          </select>
                        }
                      }
                      @case ('date') { 
                        @if(condition.operator === 'last_x_days') {
                          <input type="number" [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0" placeholder="e.g., 7">
                        } @else {
                          <input type="date" [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0"> 
                        }
                      }
                      @case ('number') { <input type="number" [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0"> }
                      @default { <input type="text" [ngModel]="condition.value" (ngModelChange)="updateConditionValue(gIndex, cIndex, $event)" class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 min-w-0"> }
                    }
                  } @else { <div class="text-sm px-2 py-1 w-full bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50 bg-slate-200 dark:bg-slate-700"></div> }
                  <button (click)="removeCondition(gIndex, cIndex)" class="text-slate-400 hover:text-red-500 p-1"><app-icon name="x" class="w-4 h-4"></app-icon></button>
                </div>
              }
            </div>
            <button (click)="addCondition(gIndex)" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline mt-1">+ Add Condition</button>
          </div>
        }
        <button (click)="addConditionGroup()" class="text-sm w-full p-2 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700">+ Add Condition Group</button>
      </div>
      <div class="p-4 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between">
        <button (click)="clearFilters()" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">Clear all</button>
        <button (click)="applyFilters()" class="px-4 py-2 bg-indigo-600 text-white rounded-md text-sm font-semibold">Apply filters</button>
      </div>
    </div>
  }

  <!-- Ticket List -->
  <div class="w-2/3 border-r border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-800 shadow-sm">
    <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <div class="relative">
              <button (click)="showViewsDropdown.set(!showViewsDropdown())" class="flex items-center gap-2 text-lg font-semibold text-slate-800 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-700 p-1 rounded-md">
                @if(app.defaultViewId() === app.activeViewId()) { <app-icon name="star" class="w-4 h-4 text-amber-500 fill-current"></app-icon> }
                <span>{{ app.activeViewId() === 'custom' ? 'Custom Filters' : activeView().name }}</span>
                @if(isViewModified()) { <span class="text-amber-500 font-bold">*</span> }
                <app-icon name="chevron-down" class="w-5 h-5 text-slate-500"></app-icon>
              </button>
              @if (showViewsDropdown()) {
                <div class="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                  @if(privateViews().length > 0) {
                     <h3 class="px-3 py-1 text-xs font-semibold text-slate-500 dark:text-slate-400">My Private Views</h3>
                     @for(view of privateViews(); track view.id) { 
                       <button (click)="selectView(view)" class="flex justify-between items-center w-full text-left px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">
                         <span class="truncate">{{view.name}}</span>
                         @if(app.defaultViewId() === view.id) { <app-icon name="star" class="w-4 h-4 text-amber-500 fill-current"></app-icon> }
                       </button> 
                      }
                  }
                  @if(teamViews().length > 0) {
                     <h3 class="px-3 py-1 text-xs font-semibold text-slate-500 dark:text-slate-400 mt-1">Team Views</h3>
                     @for(view of teamViews(); track view.id) { <button (click)="selectView(view)" class="flex justify-between items-center w-full text-left px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">{{view.name}}</button> }
                  }
                  @if(sharedViews().length > 0) {
                     <h3 class="px-3 py-1 text-xs font-semibold text-slate-500 dark:text-slate-400 mt-1">Shared Views</h3>
                     @for(view of sharedViews(); track view.id) { <button (click)="selectView(view)" class="flex justify-between items-center w-full text-left px-3 py-1.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">{{view.name}}</button> }
                  }
                </div>
              }
            </div>
             @if(app.activeViewId() !== 'all') {
               <div class="relative">
                  <button (click)="showViewActions.set(!showViewActions())" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                    <app-icon name="more-horizontal" class="w-5 h-5 text-slate-500"></app-icon>
                  </button>
                  @if (showViewActions()) {
                    <div class="absolute top-full left-0 mt-1 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                      <button (click)="app.togglePinView(app.activeViewId())" class="flex items-center w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 gap-2"><app-icon name="pin" class="w-4 h-4"></app-icon> {{ activeView().isPinned ? 'Unpin View' : 'Pin View' }}</button>
                      <button (click)="cloneView()" class="flex items-center w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 gap-2"><app-icon name="copy" class="w-4 h-4"></app-icon> Clone View</button>
                      @if(canEditActiveView()) {
                        <button (click)="openEditViewModal()" class="flex items-center w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 gap-2"><app-icon name="edit-3" class="w-4 h-4"></app-icon> Edit View</button>
                        <button (click)="renameView(app.activeViewId())" class="flex items-center w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 gap-2"><app-icon name="tag" class="w-4 h-4"></app-icon> Rename</button>
                        @if(app.defaultViewId() !== app.activeViewId()) {
                          <button (click)="setDefaultView(app.activeViewId())" class="flex items-center w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 gap-2"><app-icon name="star" class="w-4 h-4"></app-icon> Set as Default</button>
                        }
                        <button (click)="deleteView(app.activeViewId())" class="flex items-center w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700 gap-2"><app-icon name="trash" class="w-4 h-4"></app-icon> Delete View</button>
                      }
                    </div>
                  }
               </div>
            }
          </div>
          <div class="flex items-center gap-2">
             @if (showSaveActions()) {
                @if(isViewModified()){
                  <button (click)="resetViewChanges()" class="text-sm text-slate-600 dark:text-slate-300 hover:underline">Reset</button>
                }
                @if (isViewModified() && canEditActiveView()) {
                    <button (click)="updateCurrentView()" class="text-sm px-3 py-1 rounded-md bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 hover:bg-indigo-200">Update View</button>
                }
                <button (click)="openSaveViewModal()" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">Save as New</button>
             }
          </div>
        </div>
        <div class="flex items-center justify-between">
            <h2 class="text-sm text-slate-500 dark:text-slate-400">{{ filteredTickets().length }} Tickets</h2>
            <button (click)="toggleFilterPanel()" class="flex items-center gap-1 text-sm text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100">
              <app-icon name="filter" class="w-4 h-4"></app-icon> Filter
            </button>
        </div>
    </div>
    <div class="flex-1 overflow-y-auto">
      @let groups = groupedAndSortedTickets();
      @for (groupName of objectKeys(groups); track groupName) {
        @if (activeView().displayOptions.groupBy) {
          <div class="px-4 py-1 bg-slate-100 dark:bg-slate-700/50 font-semibold text-sm text-slate-600 dark:text-slate-300 sticky top-0">{{ groupName }} <span class="text-xs font-normal">({{ groups[groupName].length }})</span></div>
        }
        <table class="w-full text-sm">
          @if (!activeView().displayOptions.groupBy || groupName === objectKeys(groups)[0]) {
            <thead class="bg-slate-50 dark:bg-slate-800">
              <tr class="border-b border-slate-200 dark:border-slate-700">
                <th class="p-2 w-12 text-center">
                  <input type="checkbox" (change)="toggleSelectAll()" [checked]="areAllSelected()" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                </th>
                @for (col of activeView().displayOptions.columns; track col) { <th class="p-2 text-left font-medium text-slate-500 dark:text-slate-400">{{ getColumnName(col) }}</th> }
                <th class="w-16"></th>
              </tr>
            </thead>
          }
          <tbody>
            @for (ticket of groups[groupName]; track ticket.id) {
              <tr class="group" [class]="'border-b border-slate-200 dark:border-slate-700 transition-colors ' + (selectedTicketId() === ticket.id ? 'bg-indigo-100 dark:bg-indigo-900/50' : 'odd:bg-white even:bg-slate-50 dark:odd:bg-slate-800 dark:even:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700/50')">
                <td class="p-2 text-center">
                   <input type="checkbox" (change)="toggleSelectTicket(ticket.id)" [checked]="app.selectedTicketIds().includes(ticket.id)" (click)="$event.stopPropagation()" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                </td>
                @for (col of activeView().displayOptions.columns; track col) {
                   <td [class]="'p-2 truncate cursor-pointer ' + (col === 'subject' ? 'font-semibold text-slate-800 dark:text-slate-200' : 'text-slate-500 dark:text-slate-400')" (click)="selectTicket(ticket.id)">
                    @if(editingCell()?.ticketId === ticket.id && editingCell()?.columnId === col) {
                       @switch(col) {
                        @case('status') {
                            <select (change)="handleInlineUpdate(ticket.id, 'status', $event); $event.stopPropagation()" (blur)="stopEditing()" class="block w-full text-sm rounded-md border-indigo-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 dark:border-slate-500" [value]="ticket.status" (click)="$event.stopPropagation()">
                                <option>open</option><option>pending</option><option>resolved</option><option>closed</option>
                            </select>
                        }
                        @case('priority') {
                            <select (change)="handleInlineUpdate(ticket.id, 'priority', $event); $event.stopPropagation()" (blur)="stopEditing()" class="block w-full text-sm rounded-md border-indigo-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 dark:border-slate-500" [value]="ticket.priority" (click)="$event.stopPropagation()">
                                <option>low</option><option>medium</option><option>high</option><option>urgent</option>
                            </select>
                        }
                        @case('assignedTo') {
                             <select (change)="handleInlineUpdate(ticket.id, 'assignedTo', $event); $event.stopPropagation()" (blur)="stopEditing()" class="block w-full text-sm rounded-md border-indigo-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 dark:border-slate-500" [value]="ticket.assignedTo || 'unassigned'" (click)="$event.stopPropagation()">
                                <option value="unassigned">Unassigned</option>
                                @for(a of app.agents(); track a.id) { <option [value]="a.name">{{ a.name }}</option> }
                            </select>
                        }
                        @default { <span>{{ getColumnValue(ticket, col) }}</span> }
                       }
                    } @else {
                       @switch(col) {
                        @case('status') { 
                          <span (click)="startEditing(ticket.id, 'status', $event)" class="flex items-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-600 p-1 rounded-md">
                            <span [class]="'h-2 w-2 rounded-full ' + app.getStatusDotClass(ticket.status)"></span>
                            <span>{{ getColumnValue(ticket, col) }}</span>
                          </span> 
                        }
                        @case('priority') { <span (click)="startEditing(ticket.id, 'priority', $event)" class="hover:bg-slate-200 dark:hover:bg-slate-600 p-1 rounded-md capitalize">{{ getColumnValue(ticket, col) }}</span> }
                        @case('assignedTo') { <span (click)="startEditing(ticket.id, 'assignedTo', $event)" class="hover:bg-slate-200 dark:hover:bg-slate-600 p-1 rounded-md">{{ getColumnValue(ticket, col) }}</span> }
                        @case('subject') {
                          <div>
                            <p>{{ getColumnValue(ticket, col) }}</p>
                            @let snippet = app.getLatestMessageSnippet(ticket);
                            <p class="text-xs text-slate-400 font-normal truncate"><span class="font-semibold">{{ snippet.from }}:</span> {{ snippet.snippet }}</p>
                          </div>
                        }
                        @case('contact') {
                          <div class="flex items-center gap-2">
                            <div [class]="'w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold ' + app.getAvatarBgClass(getColumnValue(ticket, col))">
                              {{ app.getInitials(getColumnValue(ticket, col)) }}
                            </div>
                            <span>{{ getColumnValue(ticket, col) }}</span>
                          </div>
                        }
                        @default { <span>{{ getColumnValue(ticket, col) }}</span> }
                       }
                    }
                   </td> 
                }
                <td class="p-2">
                  <div class="flex items-center justify-end space-x-1 opacity-0 group-hover:opacity-100">
                    <button (click)="startEditing(ticket.id, 'status', $event)" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" title="Change Status"><app-icon name="circle" class="w-4 h-4"></app-icon></button>
                    <button (click)="startEditing(ticket.id, 'assignedTo', $event)" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400" title="Assign"><app-icon name="user" class="w-4 h-4"></app-icon></button>
                  </div>
                </td>
              </tr>
            } @empty { <tr><td class="p-4 text-center text-slate-500" [attr.colspan]="activeView().displayOptions.columns.length + 2">No tickets match your filters.</td></tr> }
          </tbody>
        </table>
      }
    </div>
    @if (app.selectedTicketIds().length > 0) {
        <app-bulk-action-bar 
            [selectedCount]="app.selectedTicketIds().length" 
            [agents]="app.agents()" 
            [availableTags]="app.availableTags()" 
            (action)="handleBulkAction($event)" 
            (cancel)="app.selectedTicketIds.set([])">
        </app-bulk-action-bar>
    }
  </div>

  <!-- Ticket Detail -->
  <div class="w-1/3">
    <app-ticket-detail 
        [ticket]="selectedTicket()" 
        [contact]="selectedContact()" 
        [agents]="app.agents()" 
        [availableTags]="app.availableTags()" 
        [hasPermission]="app.hasPermission()" 
        (addReply)="app.handleAddReply($event)" 
        (addNote)="app.handleAddNote($event)" 
        (updateTicket)="app.handleUpdateTicket($event)" 
        (openMergeModal)="app.openModalWithTicket('mergeTicket', $event)" 
        (openSplitModal)="app.openSplitModalWithMessage($event)" 
        (openLogTimeModal)="app.openModalWithTicket('logTime', $event)" 
        (openLinkTicketModal)="app.openModalWithTicket('linkTicket', $event)" 
        (createKbArticle)="noop()" 
        (viewTicket)="selectTicket($event)">
    </app-ticket-detail>
  </div>
</div>
