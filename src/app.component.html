<!-- Main App Container -->
<div [class]="(isSidebarCollapsed() ? 'ml-0' : 'md:ml-56') + ' transition-all duration-300 h-screen flex flex-col'">
  
  <!-- Header -->
  <header class="flex-shrink-0 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 h-16 flex items-center justify-between px-6">
    <div class="flex items-center">
      <button (click)="isSidebarCollapsed.set(!isSidebarCollapsed())" class="md:hidden mr-4 text-slate-500 dark:text-slate-400">
        <app-icon name="chevrons-right" class="w-6 h-6"></app-icon>
      </button>
      <div class="relative w-96">
        <app-icon name="search" class="absolute left-3 top-2.5 w-5 h-5 text-slate-400 dark:text-slate-500"></app-icon>
        <input 
          type="text" 
          placeholder="Search tickets, customers, articles..." 
          (click)="showCommandPalette.set(true)"
          readonly
          class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer"
        />
        <div class="absolute right-3 top-[7px] text-xs font-semibold text-slate-400 dark:text-slate-500 border border-slate-300 dark:border-slate-600 rounded-md px-1.5 py-0.5">⌘K</div>
      </div>
    </div>
    <div class="flex items-center space-x-4">
      <button (click)="openModal.set('newTicket')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg flex items-center space-x-2 text-sm font-semibold hover:bg-indigo-700">
        <app-icon name="plus" class="w-5 h-5"></app-icon>
        <span>{{ translations().newTicket }}</span>
      </button>
      <button (click)="toggleDarkMode()" class="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
        <app-icon [name]="isDarkMode() ? 'sun' : 'moon'" class="w-6 h-6"></app-icon>
      </button>
      <div class="relative">
        <button (click)="showLanguageMenu.set(!showLanguageMenu())" class="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
          <app-icon name="globe" class="w-6 h-6"></app-icon>
        </button>
        @if(showLanguageMenu()) {
          <div class="absolute right-0 mt-2 w-36 bg-white dark:bg-slate-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
            <a (click)="currentLanguage.set('en'); showLanguageMenu.set(false)" class="block px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">English</a>
            <a (click)="currentLanguage.set('es'); showLanguageMenu.set(false)" class="block px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">Español</a>
            <a (click)="currentLanguage.set('fr'); showLanguageMenu.set(false)" class="block px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">Français</a>
          </div>
        }
      </div>
      <div class="relative">
       <button (click)="showNotifications.set(!showNotifications())" class="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 relative">
        <app-icon name="bell" class="w-6 h-6"></app-icon>
        @if(unreadNotificationsCount() > 0) {
          <span class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500"></span>
        }
      </button>
       @if(showNotifications()) {
          <div class="absolute right-0 mt-2 w-80 bg-white dark:bg-slate-800 rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 z-20">
            <div class="p-3 font-semibold border-b dark:border-slate-700">Notifications</div>
            <div class="max-h-96 overflow-y-auto">
              @for(notification of notifications(); track notification.id) {
                <div (click)="handleNotificationClick(notification)" [class]="'p-3 flex items-start gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer ' + (!notification.read ? 'bg-indigo-50 dark:bg-indigo-900/50' : '')">
                  <div class="w-5 h-5 flex-shrink-0 mt-0.5">
                    @if(notification.message.includes('assigned')) { <app-icon name="user" class="w-5 h-5 text-indigo-500"></app-icon> }
                    @else if (notification.message.includes('mentioned')) { <app-icon name="at-sign" class="w-5 h-5 text-blue-500"></app-icon> }
                    @else { <app-icon name="alert-circle" class="w-5 h-5 text-yellow-500"></app-icon> }
                  </div>
                  <div class="flex-1">
                    <p class="text-sm text-slate-700 dark:text-slate-200">{{ notification.message }}</p>
                    <p class="text-xs text-slate-400 dark:text-slate-500">{{ notification.timestamp | date:'short' }}</p>
                  </div>
                  @if(!notification.read) {
                    <div class="w-2 h-2 rounded-full bg-indigo-500 mt-1 flex-shrink-0"></div>
                  }
                </div>
              } @empty {
                <p class="p-4 text-center text-sm text-slate-500">No new notifications.</p>
              }
            </div>
          </div>
       }
      </div>
      <button (click)="openModal.set('settings')" class="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
        <app-icon name="settings" class="w-6 h-6"></app-icon>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 overflow-hidden">
    <router-outlet></router-outlet>
  </main>
</div>

<!-- Sidebar -->
<aside [class]="(isSidebarCollapsed() ? '-translate-x-full' : 'translate-x-0') + ' fixed inset-y-0 left-0 bg-white dark:bg-slate-800 w-56 border-r border-slate-200 dark:border-slate-700 transform transition-transform duration-300 ease-in-out md:translate-x-0 z-40 flex flex-col'">
  <div class="flex items-center justify-center h-16 border-b border-slate-200 dark:border-slate-700 flex-shrink-0"> <app-icon name="briefcase" class="w-8 h-8 text-indigo-600"></app-icon> <span class="ml-2 text-xl font-bold text-slate-800 dark:text-slate-100">BoldDesk</span> </div>
  <nav class="flex-grow overflow-y-auto mt-4 px-2 pb-2">
    <a routerLink="/my-inbox" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" [routerLinkActiveOptions]="{exact: true}" class="flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="inbox" class="w-5 h-5 mr-3"></app-icon> {{ translations().myInbox }} </a>
    <a routerLink="/tickets" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" [routerLinkActiveOptions]="ticketsRouteOptions" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="mail" class="w-5 h-5 mr-3"></app-icon> {{ translations().tickets }} </a>
    @if(pinnedViews().length > 0) {
      <div class="mt-2 pt-2 border-t border-slate-200 dark:border-slate-700">
        @for(view of pinnedViews(); track view.id) {
           <a (click)="selectView(view)" [class]="'flex items-center px-4 py-2 rounded-lg cursor-pointer text-sm ' + (activeViewId() === view.id ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold' : 'text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700')"> <app-icon name="pin" class="w-4 h-4 mr-3"></app-icon> <span class="truncate">{{ view.name }}</span> </a>
        }
      </div>
    }
    <div class="mt-2 pt-2 border-t border-slate-200 dark:border-slate-700">
        <a routerLink="/analytics" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="bar-chart-3" class="w-5 h-5 mr-3"></app-icon> {{ translations().analytics }} </a>
        <a routerLink="/kb" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="library" class="w-5 h-5 mr-3"></app-icon> {{ translations().knowledgeBase }} </a>
        <a routerLink="/customers" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="users" class="w-5 h-5 mr-3"></app-icon> {{ translations().customers }} </a>
        <a routerLink="/reports" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="pie-chart" class="w-5 h-5 mr-3"></app-icon> {{ translations().reports }} </a>
        <a routerLink="/qa" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="award" class="w-5 h-5 mr-3"></app-icon> {{ translations().qualityAssurance }} </a>
        <a routerLink="/wallboard" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="tv" class="w-5 h-5 mr-3"></app-icon> {{ translations().wallboard }} </a>
        <a routerLink="/kanban" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="layout-grid" class="w-5 h-5 mr-3"></app-icon> {{ translations().kanban }} </a>
    </div>
    <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700"> <h3 class="px-4 text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">{{ translations().channels }}</h3> 
        <a routerLink="/inbox" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-2 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="inbox" class="w-5 h-5 mr-3"></app-icon> {{ translations().inbox }} </a> 
        <a routerLink="/chat" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="message-circle" class="w-5 h-5 mr-3"></app-icon> {{ translations().liveChat }} </a> 
        <a routerLink="/slack" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="slack" class="w-5 h-5 mr-3"></app-icon> {{ translations().slack }} </a> 
        <a routerLink="/facebook" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="facebook" class="w-5 h-5 mr-3"></app-icon> {{ translations().facebook }} </a> 
        <a routerLink="/twitter" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="twitter" class="w-5 h-5 mr-3"></app-icon> {{ translations().twitter }} </a> 
        <a routerLink="/whatsapp" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="phone" class="w-5 h-5 mr-3"></app-icon> {{ translations().whatsapp }} </a> 
    </div>
    <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700"> <h3 class="px-4 text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">{{ translations().integrations }}</h3> 
        <a routerLink="/salesforce" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-2 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="salesforce" class="w-5 h-5 mr-3"></app-icon> {{ translations().salesforce }} </a> 
        <a routerLink="/jira" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="mt-1 flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="jira" class="w-5 h-5 mr-3"></app-icon> {{ translations().jira }} </a> 
    </div>
  </nav>
  <div class="flex-shrink-0 p-2 border-t border-slate-200 dark:border-slate-700"> 
    <a routerLink="/portal" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="external-link" class="w-5 h-5 mr-3"></app-icon> {{ translations().customerPortal }} </a> 
    <a routerLink="/devplan" routerLinkActive="bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300 font-semibold" class="flex items-center px-4 py-2 rounded-lg cursor-pointer text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700"> <app-icon name="rocket" class="w-5 h-5 mr-3"></app-icon> {{ translations().devPlan }} </a> 
  </div>
</aside>

<!-- Modals -->
@if(showCommandPalette()) {
  <app-command-palette
    [tickets]="tickets()"
    [contacts]="contacts()"
    [kbArticles]="kbArticles()"
    (close)="showCommandPalette.set(false)"
    (commandSelected)="handleCommandPaletteAction($event)"
  ></app-command-palette>
}
@if (openModal() === 'newTicket') { <app-new-ticket-modal [contacts]="contacts()" [organizations]="organizations()" [customFieldDefinitions]="customFieldDefs()" [formTemplates]="formTemplates()" [knowledgeBaseArticles]="kbArticles()" (close)="closeModal()" (create)="handleCreateTicket($event)"></app-new-ticket-modal> }
@if (openModal() === 'mergeTicket' && selectedTicketForModal()) { <app-merge-ticket-modal [currentTicket]="selectedTicketForModal()!" [allTickets]="tickets()" [contacts]="contacts()" (close)="closeModal()" (merge)="handleMergeTickets($event)"></app-merge-ticket-modal> }
@if (openModal() === 'splitTicket' && selectedMessageForModal()) { <app-split-ticket-modal [messageToSplit]="selectedMessageForModal()!" (close)="closeModal()" (split)="handleSplitTicket($event)"></app-split-ticket-modal> }
@if (openModal() === 'csat' && selectedTicketForModal()) { <app-csat-modal [ticket]="selectedTicketForModal()!" (close)="closeModal()" (submit)="handleCsatSubmit($event)"></app-csat-modal> }
@if (openModal() === 'settings') { 
  <app-settings-modal 
    [roles]="roles()" 
    [allPermissions]="allPermissions()" 
    [automationRules]="automationRules()" 
    [groups]="groups()" 
    [slaRules]="slaRules()" 
    [formTemplates]="formTemplates()" 
    [currentAgent]="currentAgent()" 
    [ssoSettings]="ssoSettings()" 
    [auditLog]="auditLog()" 
    [apiKeys]="apiKeys()" 
    [webhooks]="webhooks()" 
    [ticketViews]="ticketViews()" 
    (close)="closeModal()" 
    (saveRoles)="handleSaveRoles($event)" 
    (saveSsoSettings)="handleSaveSsoSettings($event)"
    (saveAutomationRules)="handleSaveAutomationRules($event)"
    (saveSlaRules)="handleSaveSlaRules($event)"
    (saveFormTemplates)="handleSaveFormTemplates($event)"
    (createApiKey)="handleCreateApiKey($event)" 
    (revokeApiKey)="handleRevokeApiKey($event)" 
    (saveWebhooks)="handleSaveWebhooks($event)"></app-settings-modal> 
}
@if (openModal() === 'logTime' && selectedTicketForModal()) { <app-log-time-modal (close)="closeModal()" (logTime)="handleLogTime($event)"></app-log-time-modal> }
@if (openModal() === 'linkTicket' && selectedTicketForModal()) { <app-link-ticket-modal [currentTicket]="selectedTicketForModal()!" [allTickets]="tickets()" [contacts]="contacts()" (close)="closeModal()" (link)="handleLinkTicket($event)"></app-link-ticket-modal> }
@if (openModal() === 'shortcuts') { <app-keyboard-shortcuts-modal (close)="closeModal()"></app-keyboard-shortcuts-modal> }
@if (openModal() === 'newKanbanBoard') { <app-new-kanban-board-modal [workspaces]="kanbanWorkspaces()" (close)="closeModal()" (create)="handleCreateKanbanBoard($event)"></app-new-kanban-board-modal> }

<!-- Toast Notifications Container -->
<div class="fixed top-5 right-5 z-[100] space-y-2">
  @for (toast of toasts(); track toast.id) {
    <div class="max-w-sm w-full bg-white dark:bg-slate-800 shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden animate-fade-in-right">
      <div class="p-4">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <app-icon [name]="toast.icon" class="w-6 h-6" [class]="toast.type === 'success' ? 'text-green-500' : (toast.type === 'error' ? 'text-red-500' : 'text-blue-500')"></app-icon>
          </div>
          <div class="ml-3 w-0 flex-1 pt-0.5">
            <p class="text-sm font-medium text-slate-900 dark:text-slate-100">{{ toast.message }}</p>
          </div>
          <div class="ml-4 flex-shrink-0 flex">
            <button (click)="removeToast(toast.id)" class="inline-flex text-slate-400 rounded-md hover:text-slate-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              <span class="sr-only">Close</span>
              <app-icon name="x" class="w-5 h-5"></app-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>

<style>
@keyframes fade-in-right {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}
.animate-fade-in-right {
  animation: fade-in-right 0.3s ease-out forwards;
}

.whatsapp-bg {
  background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg');
  background-size: cover;
  background-position: center;
}
</style>